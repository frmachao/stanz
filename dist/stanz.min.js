/*!
* stanz v6.1.11
* https://github.com/kirakiray/stanz
* 
* (c) 2018-2021 YAO
* Released under the MIT License.
*/((e,t)=>{"use strict";"object"==typeof exports?module.exports=t():"function"==typeof define&&define.amd?define(t):e.stanz=t()})(this,()=>{"use strict";const e=()=>Math.random().toString(32).substr(2);let t=Object.prototype.toString;const s=e=>t.call(e).toLowerCase().replace(/(\[object )|(])/g,""),a=e=>void 0===e,n=e=>JSON.parse(JSON.stringify(e)),r=(()=>{if(null!==document.currentScript.getAttribute("debug")){let t=new Map;return(s,a)=>{a||(a=e());let n=t.get(a);clearTimeout(n),t.set(a,setTimeout(()=>{s(),t.delete(a)}))}}let t=!1,s=new Map,a=setTimeout;return"object"==typeof process&&process.nextTick&&(a=process.nextTick),(n,r)=>{t||(t=!0,a(()=>{s.size&&s.forEach(({key:e,fun:t})=>{try{t()}catch(e){console.error(e)}s.delete(e)}),s.clear(),t=!1})),r||(r=e()),s.set(r,{key:r,fun:n})}})(),i=(t,s,a,r,i)=>{let l;l=t._modifyId?t._modifyId:e(),S(t,k).push(l),o(t);let c=new g({type:"update",target:t[x]||t});Object.defineProperties(c,{trend:{get:()=>new T(c)}}),r&&Object.assign(c,r),c.modify={name:s,args:a.map(e=>e instanceof K?e.object:e instanceof Object?n(e):e),mid:l},i&&i(c),t.emit(c)};let l,c=new Set;const o=e=>{e[k].length<50||(clearTimeout(l),c.add(e),l=setTimeout(()=>{let e=Array.from(c);setTimeout(()=>{e.forEach(e=>o(e))},1e3),c.forEach(e=>{let t=e[k];t.splice(0,Math.ceil(t.length/2))}),c.clear()},3e3))},h=e=>{if(!(e instanceof K))return;let t=e[O];if(t)try{t.index=void 0,t.parent=void 0}catch(e){}if(e instanceof J){let{mappingXData:s}=e,a=s[E].find(e=>e.data===t),{leftUpdate:n,rightUpdate:r}=a;e.off("update",r),s.off("update",n),t.mappingXData=null}if(t[D])for(let[s,a]of t[D])e.unsync(s);t[E]&&(t[E].forEach(e=>{let{data:s,leftUpdate:a,rightUpdate:n}=e;s.off("update",n),t.off("update",a),s.mappingXData=null}),t[E].splice(0)),t[v]&&t[v].clear(),t[u]&&t[u].clear()},f=(e,t)=>{let a=e;switch(s(e)){case"object":case"array":a=new K(e,t)}return a},d=(e,t)=>{if(e instanceof Array)return e.map(e=>d(e,t));if(e instanceof Object){let s={},a=[];return Object.keys(e).forEach(n=>{/\D/.test(n)?s[n]=d(e[n]):a.push(d(e[n],t))}),a.length&&(s[t]=a),s}return e},u=Symbol("events"),p=(e,t)=>{let s=t[u];s||(s=new Map,Object.defineProperty(t,u,{value:s}));let a=s.get(e);return a||(a=[],s.set(e,a)),a},b=(e,t)=>{let s;return e instanceof g?e=(s=e).type:s=new g({type:e,target:t[x]||t}),s};class y{constructor(e={}){Object.defineProperties(this,{parent:{writable:!0,value:e.parent,configurable:!0},index:{writable:!0,value:e.index,configurable:!0}})}on(e,t,s){this.addListener({type:e,data:s,callback:t})}one(e,t,s){this.addListener({count:1,type:e,data:s,callback:t})}addListener(e={}){let{type:t,data:s,callback:n,count:r=1/0,eventId:i}=e;if(!t)throw{desc:"addListener no type",options:e};let l=t.split("#");1 in l&&(t=l[0],i=l[1]);let c=p(t,this);a(i)||Array.from(c).some(e=>{if(e.eventId===i){let t=c.indexOf(e);return t>-1&&c.splice(t,1),!0}}),n&&c.push({type:t,data:s,callback:n,eventId:i,count:r})}off(e,t){if(e){if(!t)throw{desc:"off must have callback"};{let s=p(e,this),a=s.findIndex(e=>e.callback==t);a>-1&&s.splice(a,1)}}}emitHandler(e,t){let s=b(e,this);e=s.type;let a=p(e,this),n=[];return s.currentTarget=this[x]||this,a.some(e=>{e.data&&(s.data=e.data),e.eventId&&(s.eventId=e.eventId);let a={self:this,event:s,emitData:t};if((e.before?e.before(a):1)&&e.callback.call(this[x]||this,s,t),e.after&&e.after(a),delete s.data,delete s.eventId,e.count--,e.count||n.push(e),s.cancel)return!0}),delete s.currentTarget,n.forEach(e=>{let t=a.indexOf(e);t>-1&&a.splice(t,1)}),s}emit(e,t){let s=this.emitHandler(e,t);if(s.bubble&&!s.cancel){let{parent:e}=this;e&&(s.keys.unshift(this.index),e.emit(s,t))}}}class g extends y{constructor(e){super(),this.type=e.type,this.target=e.target,this._bubble=!0,this._cancel=!1,this.keys=[]}get bubble(){return this._bubble}set bubble(e){this._bubble!==e&&(this.emitHandler("set-bubble",e),this._bubble=e)}get cancel(){return this._cancel}set cancel(e){this._cancel!==e&&(this.emitHandler("set-cancel",e),this._cancel=e)}}const m=/^_.+|^index$|^length$|^object$|^getData$|^setData$/,j=/^parent$|^index$|^length$|^object$/;let w={get:(e,t,s)=>"symbol"==typeof t||m.test(t)?Reflect.get(e,t,s):e.getData(t),set:(e,t,s,a)=>"symbol"==typeof t?Reflect.set(e,t,s,a):e.setData(t,s)};const x=Symbol("proxyThis"),O=Symbol("XDataSelf"),v=Symbol("WatchHost"),k=Symbol("ModifyIDS"),D=Symbol("SyncHost"),E=Symbol("VirDataHost"),_=Symbol("StanzID"),S=(e,t)=>{let s=e[t];if(!s){switch(t){case v:case D:s=new Map;break;case k:case E:s=[]}Object.defineProperty(e,t,{value:s})}return s},I="undefined"!=typeof Element;class K extends y{constructor(t,s={}){super(s);let a=new Proxy(this,w),n=0;Object.keys(t).forEach(e=>{let s=t[e];/^\_/.test(e)||I&&s instanceof Element?Object.defineProperty(this,e,{configurable:!0,writable:!0,value:s}):(/\D/.test(e)||(e=parseInt(e))>=n&&(n=e+1),s instanceof Object?this[e]=new K(s,{parent:this,index:e}):this[e]=s)});const r=e();Object.defineProperties(this,{[O]:{get:()=>this},[x]:{value:a},[_]:{value:r},xid:{get:()=>r},_modifyId:{value:null,writable:!0},length:{configurable:!0,writable:!0,value:n}})}setData(e,t){if(j.test(e))return console.warn("you can't set this key in XData => ",e),!1;if(/^_.+/.test(e))return Object.defineProperty(this,e,{configurable:!0,writable:!0,value:t}),!0;let a=this[O];if(/\./.test(e)){let s=e.split("."),n=s.length-1;return s.some((t,s)=>{if(s==n)return e=t,!0;a=a[t]}),a.setData(e,t),!0}if("string"===s(e)){let s=a[e];return t===s||(s instanceof K&&(s=s.object),t instanceof K?((t=t[O]).remove(),t.parent=a,t.index=e):t instanceof Object&&(t=f(t,{parent:a,index:e})),a[e]=t,i(a,"setData",[e,t],{oldValue:s}),!0)}if(e instanceof Object){let t=e;return Object.keys(t).forEach(e=>{let s=t[e];a.setData(e,s)}),!0}}getData(e){let t=this[e];return t instanceof K&&(t=t[x]),t}remove(e){if(a(e)){let{parent:e}=this;e?e.remove(this.index):h(this)}else{let t=this[e];/\D/.test(e)?(delete this[e],h(t),i(this,"remove",[e])):this.splice(parseInt(e),1)}}deepClear(){Object.keys(this).forEach(e=>{if(/\D/.test(e)){let t=this[e];t instanceof K&&t.deepClear()}}),this.forEach(e=>{e instanceof K&&e.deepClear()}),h(this)}add(e){!this.includes(e)&&this.push(e)}delete(e){let t=this.indexOf(e);t>-1&&this.splice(t,1)}has(e){return this.includes(e)}clear(){this.splice(0,this.length)}before(e){if(/\D/.test(this.index))throw{text:"It must be an array element",target:this,index:this.index};return this.parent.splice(this.index,0,e),this}after(e){if(/\D/.test(this.index))throw{text:"It must be an array element",target:this,index:this.index};return this.parent.splice(this.index+1,0,e),this}clone(){return f(n(this))[x]}emitHandler(e,t){let s=b(e,this);if("update"===s.type){let{_unBubble:e,_update:t,_unpush:a}=this,{fromKey:n}=s.trend;(!1===t||e&&e.includes(n))&&(s.bubble=!1),a&&a.includes(n)&&Object.defineProperty(s,"_unpush",{value:!0})}return y.prototype.emitHandler.call(this,s,t),s}noStanz(e={childKey:"children"}){return d(this.object,e.childKey)}get object(){let e={},t=!0,{_unBubble:s=[]}=this;return Object.keys(this).forEach(a=>{if(/^_/.test(a)||!/\D/.test(a)||s.includes(a))return;let n=this[a];if(n instanceof K){if(!1===n._update)return;n=n.object}e[a]=n,t=!1}),this.forEach((t,s)=>{t instanceof K&&(t=t.object),e[s]=t}),t&&(e.length=this.length,e=Array.from(e)),e}get string(){return JSON.stringify(this.object)}toJSON(){return JSON.stringify(this.object)}get root(){let e=this;for(;e.parent;)e=e.parent;return e}get prev(){if(!/\D/.test(this.index)&&this.index>0)return this.parent.getData(this.index-1)}get next(){if(!/\D/.test(this.index))return this.parent.getData(this.index+1)}getTarget(e){let t=this;return e.length&&e.some(e=>{if(!t)return console.warn("getTarget failure"),!0;t=t[e]}),t}seek(e){let t=s(e);if("function"===t){let t=[],s=s=>{if(s instanceof K){e(s)&&t.push(s);let a=s.seek(e);t=[...t,...a]}};return Object.keys(this).forEach(e=>{/\D/.test(e)&&s(this[e])}),this.forEach(s),s=null,t}if("string"===t){let t,s=(e=e.replace(/[\[\]]/g,"")).split("=");if(2==s.length){let[e,a]=s;t=(t=>t[e]==a)}else{let[e]=s;t=(t=>Object.keys(t).includes(e))}return this.seek(t)}}watch(e,t,a){let n,i=s(e);if("object"===i)return void Object.keys(e).forEach(t=>{this.watch(t,e[t])});/function/.test(i)&&(a=t,t=e,e=""),n=""===e?"watchSelf":e instanceof RegExp?"watchKeyReg":/\[.+\]/.test(e)?"seekData":/\./.test(e)?"watchPointKey":"watchKey";let l=S(this,v).get(e);l||(l=new Set,S(this,v).set(e,l));let c,o={trends:[],callback:t,expr:e,push(e){this.trends.push(e)}};l.add(o);let h=this[x];switch(n){case"watchSelf":c=(e=>{o.push(e.trend),r(()=>{t.call(h,{trends:Array.from(o.trends)},h),o.trends.length=0},o)}),!0===a&&t.call(h,{trends:[]},h);break;case"watchKey":case"watchKeyReg":c=(s=>{let{trend:a}=s;("watchKeyReg"===n&&e.test(a.fromKey)||a.fromKey==e)&&(o.push(s.trend),o.cacheOld||(o._oldVal=s.oldValue instanceof K?s.oldValue.object:s.oldValue,o.cacheOld=!0),r(()=>{let s=this[e];t.call(h,{expr:e,val:s,old:o._oldVal,trends:Array.from(o.trends)},s),o.trends.length=0,o._oldVal=o.cacheOld=!1},o))}),!0===a&&t.call(h,{expr:e,val:h[e],trends:[]},h[e]);break;case"watchPointKey":let s=e.split("."),i=s[0],l=this.getTarget(s);c=(a=>{let{trend:n}=a;if(n.fromKey==i){let i;try{i=this.getTarget(s)}catch(a){}i!==l&&(o.push(n),r(()=>{(i=this.getTarget(s))!==l&&t.call(h,{expr:e,old:l,val:i,trends:Array.from(o.trends)},i),o.trends.length=0},o))}}),!0===a&&t.call(h,{expr:e,val:l},l);break;case"seekData":let f=h.seek(e);c=(s=>{r(()=>{let s=h.seek(e),a=1;s.length===f.length?s.some(e=>{if(!f.includes(e))return a=0,!0}):a=0,!a&&t.call(h,{expr:e,old:f,val:s},s),f=s},o)}),!0===a&&t.call(h,{expr:e,old:f,val:f},f)}return this.on("update",c),o.updateMethod=c,this}unwatch(e,t){let a=s(e);if("object"===a)return Object.keys(e).forEach(t=>{this.unwatch(t,e[t])}),this;/function/.test(a)&&(t=e,e="");let n=S(this,v).get(e);if(n){let s=Array.from(n).find(s=>s.callback===t&&s.expr===e);s&&(s.updateMethod&&this.off("update",s.updateMethod),n.delete(s),!n.size&&S(this,v).delete(e))}return this}watchUntil(e){if(/[^=]=[^=]/.test(e))throw"cannot use single =";return new Promise(t=>{let s,a=new Function(`\n            try{with(this){\n                return ${e}\n            }}catch(e){}`).bind(this);this.watch(s=(()=>{let e=a();e&&(this.unwatch(s),t(e))}),!0)})}entrend(e){let{mid:t,keys:s,name:a,args:n,_unpush:r}=e;if(r)return;let{_unpull:i}=this,l=P(e);if(i&&i.includes(l))return;if(!t)throw{text:"Illegal trend data"};let c=this.getTarget(s);if(c){let e=c[O];if(S(e,k).includes(t))return!1;e._modifyId=t,e[a](...n),e._modifyId=null}return!0}}const P=e=>{let t=e.keys[0];return!a(t)||"setData"!==e.name&&"remove"!==e.name||(t=e.args[0]),t};class T{constructor(e){if(e instanceof g){let{modify:{name:t,args:s,mid:a},keys:r}=n(e),{_unpush:i}=e;i&&Object.defineProperty(this,"_unpush",{value:!0}),Object.assign(this,{name:t,args:s,mid:a,keys:r})}else Object.assign(this,e)}get string(){return JSON.stringify(this)}get finalSetterKey(){switch(this.name){case"remove":case"setData":return this.args[0]}}get fromKey(){return P(this)}set fromKey(e){let t=this.keys[0];a(t)?"setData"!==this.name&&"remove"!==this.name||(this.args[0]=e):this.keys[0]=e}}const M=(e,t,s)=>{t.trends.forEach(t=>{t.fromKey===e&&s.entrend(t)})},A=(e,t,s)=>{t.trends.forEach(t=>{e.includes(t.fromKey)&&s.entrend(t)})},V=(e,t,s)=>{n(t.trends).forEach(t=>{t=new T(t);let{fromKey:n}=t;if(!a(n)){let a=e.get(n);a&&(t.fromKey=a,s.entrend(t))}})},H=e=>(e instanceof K&&(e=e.object),e),$=(e,t,s)=>{Object.keys(e).forEach(a=>{let n=e[a];if(n instanceof Object){t[a]||(t.setData?t.setData(a,{}):t[a]={});let e=t[a];$(n,e,s)}else{let r=s([a,n],{self:e,target:t});if(r){let[e,s]=r;t[e]=s}}})},U=(e,t,s)=>{let{trend:n}=t;if(n){switch(n.name){case"setData":let e=n.args[1];if(e instanceof Object){let t={};$(e,t,s),n.args[1]=t}else a(e)||(n.args=s(n.args,{event:t}));break;default:n.args=n.args.map(e=>{let t=e;return e instanceof Object&&$(e,t={},s),t})}e.entrend(n)}},W={sync(e,t,a){let n,r;switch(s(t)){case"string":a&&e.setData(t,H(this[t])),n=(s=>M(t,s,e)),r=(e=>M(t,e,this));break;case"array":a&&t.forEach(t=>{e.setData(t,H(this[t]))}),n=(s=>A(t,s,e)),r=(e=>A(t,e,this));break;case"object":let i=new Map(Object.entries(t)),l=new Map(Object.entries(t).map(e=>e.reverse()));a&&Object.keys(t).forEach(s=>{e.setData(t[s],H(this[s]))}),n=(t=>V(i,t,e)),r=(e=>V(l,e,this));break;default:if(a){let t=this.object;Object.keys(t).forEach(s=>{e.setData(s,t[s])})}n=(t=>t.trends.forEach(t=>e.entrend(t))),r=(e=>e.trends.forEach(e=>this.entrend(e)))}this.watch(n),e.watch(r);let i=S(this,D);i.has(e)&&this.unsync(e),i.set(e,{selfWatch:n,oppWatch:r}),S(e,D).set(this,{selfWatch:r,oppWatch:n})},unsync(e){let t=S(this,D).get(e);if(t){let{selfWatch:s,oppWatch:a}=t;this.unwatch(s),e.unwatch(a),S(this,D).delete(e),S(e,D).delete(this)}},virData(e,t){let a,n,r=new J(this[O],{}),i=s(e),l=e;if("object"==i)if("mapKey"in l){let s=Object.entries(l.mapKey),a=new Map(s),n=new Map(s.map(e=>e.reverse()));e=(([e,t])=>a.has(e)?[a.get(e),t]:[e,t]),t=(([e,t])=>n.has(e)?[n.get(e),t]:[e,t])}else if("mapValue"in l){let s=l.key,a=Object.entries(l.mapValue),n=new Map(a),r=new Map(a.map(e=>e.reverse()));e=(([e,t])=>e===s&&n.has(t)?[e,n.get(t)]:[e,t]),t=(([e,t])=>e===s&&r.has(t)?[e,r.get(t)]:[e,t])}return $(this,r,e),this.on("update",a=(t=>U(r,t,e))),r.on("update",n=(e=>U(this,e,t))),S(this,E).push({data:r,leftUpdate:a,rightUpdate:n}),r[x]}};Object.keys(W).forEach(e=>{Object.defineProperty(K.prototype,e,{writable:!0,value:W[e]})});class J extends K{constructor(e,...t){super(...t),Object.defineProperty(this,"mappingXData",{writable:!0,value:e})}}["concat","every","filter","find","findIndex","forEach","map","slice","some","indexOf","lastIndexOf","includes","join"].forEach(e=>{let t=Array.prototype[e];t&&Object.defineProperty(K.prototype,e,{value(...e){return t.apply(this,e)}})});const N=(e,t,s)=>{t!==s&&e.emitHandler("updateIndex",{oldIndex:s,index:t})};["pop","push","reverse","splice","shift","unshift"].forEach(e=>{let t=Array.prototype[e];t&&Object.defineProperty(K.prototype,e,{value(...s){let a=[],n=this[O],r=n.object;s.forEach(e=>{if(e instanceof K){let t=e[O];t.remove(),a.push(t)}else{let t=f(e,{parent:n});a.push(t)}});let l=t.apply(n,a);switch(n.forEach((e,t)=>{if(e instanceof K){let s=e.index;e.index=t,N(e,t,s)}}),e){case"shift":case"pop":l instanceof K&&h(l);break;case"splice":l.forEach(e=>{e instanceof K&&h(e)})}return i(n,e,s,{oldValue:r}),l}})}),Object.defineProperties(K.prototype,{sort:{value(e){let t=[],a=this[O],n=a.object,r=Array.from(a);if((e=>s(e).includes("function"))(e)||!e){Array.prototype.sort.call(a,e),a.forEach((e,t)=>{if(e instanceof K){let s=e.index;e.index=t,N(e,t,s)}}),t=[r.map(e=>e.index)],r=null}else e instanceof Array&&(e.forEach((e,t)=>{let s=a[e]=r[t],n=s.index;s.index=e,N(s,e,n)}),t=[e]);return i(a,"sort",t,{oldValue:n}),this}}});let R=e=>f(e)[x];return R.version="6.1.11",R.v=6001011,R});