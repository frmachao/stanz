(e=>{window.stanz=e})((()=>{"use strict";const e=()=>Math.random().toString(32).substr(2);let t=Object.prototype.toString;const s=e=>t.call(e).toLowerCase().replace(/(\[object )|(])/g,""),a=e=>void 0===e,i=e=>JSON.parse(JSON.stringify(e)),r=(()=>{let t=!1,s=new Map;return(a,i)=>{t||(t=!0,setTimeout(()=>{s.size&&s.forEach(e=>{e()}),s.clear(),t=!1},0)),i||(i=e()),s.set(i,a)}})(),n=(t,s,a,r)=>{let n;n=t._modifyId?t._modifyId:e(),k(t,w).push(n);let l=new f({type:"update",target:t[b]||t});Object.defineProperties(l,{trend:{get:()=>new O(l)}}),r&&Object.assign(l,r),l.modify={name:s,args:i(a),mid:n},t.emit(l)},l=e=>{let t=e[g];t&&(t.index=void 0,t.parent=void 0)},c=(e,t)=>{let a=e;switch(s(e)){case"object":case"array":a=new v(e,t)}return a},h=Symbol("events"),o=(e,t)=>{let s=t[h];s||(s=new Map,Object.defineProperty(t,h,{value:s}));let a=s.get(e);return a||(a=[],s.set(e,a)),a};class d{constructor(e={}){Object.defineProperties(this,{parent:{writable:!0,value:e.parent},index:{writable:!0,value:e.index}})}on(e,t,s){this._on({type:e,data:s,callback:t})}one(e,t,s){this._on({count:1,type:e,data:s,callback:t})}_on(e={}){let{type:t,data:s,callback:i,count:r=1/0,eventId:n}=e,l=t.split("#");1 in l&&(t=l[0],n=l[1]);let c=o(t,this);a(n)||Array.from(c).some(e=>{if(e.eventId===n){let t=c.indexOf(e);return t>-1&&c.splice(t,1),!0}}),i&&c.push({type:t,data:s,callback:i,eventId:n,count:r})}off(e,t){if(e)if(t){let s=o(e,this),a=s.findIndex(e=>e.callback==t);a>-1&&s.splice(a,1)}else this[h]&&this[h].delete(e)}emit(e,t){let s;e instanceof f?e=(s=e).type:s=new f({type:e,target:this[b]||this});let a=o(e,this),i=[];if(s.currentTarget=this[b]||this,a.forEach(e=>{e.data&&(s.data=e.data),e.eventId&&(s.eventId=e.eventId),e.callback.call(this[b]||this,s,t),delete s.data,delete s.eventId,e.count--,e.count||i.push(e)}),delete s.currentTarget,i.forEach(e=>{let t=a.indexOf(e);t>-1&&a.splice(t,1)}),s.bubble&&!s.cancel){let{parent:e}=this;e&&(s.keys.unshift(this.index),e.emit(s,t))}}}class f{constructor(e){this.type=e.type,this.target=e.target,this.bubble=!0,this.cancel=!1,this.keys=[]}}const p=/^_.+|^index$|^length$|^object$/,u=/^parent$|^index$|^length$|^object$/;let y={get:(e,t,s,a)=>"symbol"==typeof t||p.test(t)?Reflect.get(e,t,s,a):e.getData(t),set:(e,t,s,a)=>"symbol"==typeof t||/^_.+/.test(t)?Reflect.set(e,t,s,a):u.test(t)?(console.warn("you can't set this key in XData => ",t),!1):e.setData(t,s)};const b=Symbol("proxyThis"),g=Symbol("XDataSelf"),m=Symbol("WatchHost"),w=Symbol("ModifyIDS"),j=Symbol("SyncHost"),x=Symbol("VirDataHost"),k=(e,t)=>{let s=e[t];if(!s){switch(t){case m:case j:s=new Map;break;case w:case x:s=[]}Object.defineProperty(e,t,{value:s})}return s};class v extends d{constructor(e,t={}){super(t);let s=new Proxy(this,y),a=0;Object.keys(e).forEach(t=>{let s=e[t];/\D/.test(t)||(t=parseInt(t))>=a&&(a=t+1),s instanceof Object?this[t]=new v(s,{parent:this,index:t}):this[t]=s}),Object.defineProperties(this,{[g]:{get:()=>this},[b]:{value:s},_modifyId:{value:null,writable:!0},length:{writable:!0,value:a}})}setData(e,t){let a=this[g];if("string"===s(e)){let s=a[e];if(t===s)return;t instanceof v?((t=t[g]).remove(),t.parent=a,t.index=e):t instanceof Object&&(t=c(t,{parent:a,index:e})),a[e]=t,n(a,"setData",[e,t],{oldValue:s})}else if(e instanceof Object){let t=e;return Object.keys(t).forEach(e=>{let s=t[e];a.setData(e,s)}),!0}}getData(e){let t=this[e];return t instanceof v&&(t=t[b]),t}remove(e){if(a(e)){let{parent:e}=this;e?e.remove(this.index):l(this)}else{let t=this[e];/\D/.test(e)?(delete this[e],l(t),n(this,"remove",[e])):this.splice(parseInt(e),1)}}add(e){!this.includes(e)&&this.push(e)}delete(e){let t=this.indexOf(e);t>-1&&this.splice(t,1)}has(e){return this.includes(e)}clear(){this.splice(0,this.length)}before(e){if(/\D/.test(this.index))throw{text:"It must be an array element",target:this,index:this.index};return this.parent.splice(this.index,0,e),this}after(e){if(/\D/.test(this.index))throw{text:"It must be an array element",target:this,index:this.index};return this.parent.splice(this.index+1,0,e),this}clone(){return c(i(this))[b]}get object(){let e={},t=!0;return Object.keys(this).forEach(s=>{let a=this[s];a instanceof v&&(a=a.object),e[s]=a,/\D/.test(s)&&(t=!1)}),t&&(e.length=this.length,e=Array.from(e)),e}get string(){return JSON.stringify(this.object)}get root(){let e=this;for(;e.parent;)e=e.parent;return e}get prev(){if(!/\D/.test(this.index)&&this.index>0)return this.parent[this.index-1]}get next(){if(!/\D/.test(this.index))return this.parent[this.index+1]}getTarget(e){let t=this;return e.length&&e.forEach(e=>{t=t[e]}),t}seek(e){let t=s(e);if("function"===t){let t=[];return Object.keys(this).forEach(s=>{let a=this[s];if(a instanceof v){e(a)&&t.push(a);let s=a.seek(e);t=[...t,...s]}}),t}if("string"===t){let t,s=(e=e.replace(/[\[\]]/g,"")).split("=");if(2==s.length){let[e,a]=s;t=(t=>t[e]==a)}else{let[e]=s;t=(t=>Object.keys(t).includes(e))}return this.seek(t)}}watch(e,t,a){let i=s(e);if("object"===i)return void Object.keys(e).forEach(t=>{this.watch(t,e[t])});/function/.test(i)&&(t=e,e="");let n;n=""==e?"watchSelf":/\[.+\]/.test(e)?"seekData":"watchKey";let l=k(this,m).get(e);l||(l=new Set,k(this,m).set(e,l));let c={trends:[],callback:t,expr:e};l.add(c);let h;switch(n){case"watchSelf":h=(e=>{c.trends.push(e.trend),r(()=>{t.call(this,{trends:Array.from(c.trends)},this),c.trends.length=0},c)}),!0===a&&t.call(this,{trends:[]},this);break;case"watchKey":h=(s=>{s.keys[0]==e&&(c.trends.push(s.trend),r(()=>{let s=this[e];t.call(this,{expr:e,val:s,trends:Array.from(c.trends)},s),c.trends.length=0},c))}),!0===a&&t.call(this,{expr:e,val:this[e],trends:[]},this[e]);break;case"seekData":let s=this.seek(e);h=(a=>{r(()=>{let a=this.seek(e),i=1;a.length===s.length?a.some(e=>{if(!s.includes(e))return i=0,!0}):i=0,!i&&t.call(this,{expr:e,old:s,val:a},a),s=a},c)}),!0===a&&t.call(this,{expr:e,old:s,val:s},s)}return this.on("update",h),c.updateMethod=h,this}unwatch(e,t){let a=s(e);if("object"===a)return Object.keys(e).forEach(t=>{this.unwatch(t,e[t])}),this;/function/.test(a)&&(t=e,e="");let i=k(this,m).get(e);if(i){let s=Array.from(i).find(s=>s.callback===t&&s.expr===e);s&&(this.off("update",s.updateMethod),i.delete(s),!i.size&&k(this,m).delete(e))}return this}entrend(e){let{mid:t,keys:s,name:a,args:i}=e;if(!t)throw{text:"Illegal trend data"};if(k(this,w).includes(t))return!1;let r=this.getTarget(s);return r._modifyId=t,r[a](...i),r._modifyId=null,!0}}class O{constructor(e){if(e instanceof f){let{modify:{name:t,args:s,mid:a},keys:r}=i(e);Object.assign(this,{name:t,args:s,mid:a,keys:r})}else Object.assign(this,e)}get string(){return JSON.stringify(this)}get finalSetterKey(){switch(this.name){case"remove":case"setData":return this.args[0]}}get fromKey(){let e=this.keys[0];return!a(e)||"setData"!==this.name&&"remove"!==this.name||(e=this.args[0]),e}set fromKey(e){let t=this.keys[0];a(t)?"setData"!==this.name&&"remove"!==this.name||(this.args[0]=e):this.keys[0]=e}}const D=(e,t,s)=>{t.trends.forEach(t=>{t.fromKey===e&&s.entrend(t)})},E=(e,t,s)=>{t.trends.forEach(t=>{e.includes(t.fromKey)&&s.entrend(t)})},I=(e,t,s)=>{i(t.trends).forEach(t=>{t=new O(t);let{fromKey:i}=t;if(!a(i)){let a=e.get(i);a&&(t.fromKey=a,s.entrend(t))}})},S=e=>(e instanceof v&&(e=e.object),e),M=(e,t,s)=>{Object.keys(e).forEach(a=>{let i=e[a];if(i instanceof Object){t[a]||(t.setData?t.setData(a,{}):t[a]={});let e=t[a];M(i,e,s)}else{let r=s([a,i],{self:e,target:t});if(r){let[e,s]=r;t[e]=s}}})},K=(e,t,s)=>{let{trend:i}=t;if(i){switch(i.name){case"setData":let e=i.args[1];if(e instanceof Object){let t={};M(e,t,s),i.args[1]=t}else a(e)||(i.args=s(i.args,{event:t}));break;default:i.args=i.args.map(e=>{let t=e;return e instanceof Object&&M(e,t={},s),t})}e.entrend(i)}},P={sync(e,t,a){let i,r;switch(s(t)){case"string":a&&e.setData(t,S(this[t])),i=(s=>D(t,s,e)),r=(e=>D(t,e,this));break;case"array":a&&t.forEach(t=>{e.setData(t,S(this[t]))}),i=(s=>E(t,s,e)),r=(e=>E(t,e,this));break;case"object":let n=new Map(Object.entries(t)),l=new Map(Object.entries(t).map(e=>e.reverse()));a&&Object.keys(t).forEach(s=>{e.setData(t[s],S(this[s]))}),i=(t=>I(n,t,e)),r=(e=>I(l,e,this));break;default:a&&e.setData(this.object),i=(t=>t.trends.forEach(t=>e.entrend(t))),r=(e=>e.trends.forEach(e=>this.entrend(e)))}this.watch(i),e.watch(r);let n=k(this,j);n.has(e)&&this.unsync(e),n.set(e,{selfWatch:i,oppWatch:r}),k(e,j).set(this,{selfWatch:r,oppWatch:i})},unsync(e){let t=k(this,j).get(e);if(t){let{selfWatch:s,oppWatch:a}=t;this.unwatch(s),e.unwatch(a),k(this,j).delete(e),k(e,j).delete(this)}console.log("unsync data => ",this)},virData(e,t){let a=new A(this[g],{}),i=s(e),r=e;if("object"==i)if("mapKey"in r){let s=Object.entries(r.mapKey),a=new Map(s),i=new Map(s.map(e=>e.reverse()));e=(([e,t])=>a.has(e)?[a.get(e),t]:[e,t]),t=(([e,t])=>i.has(e)?[i.get(e),t]:[e,t])}else if("mapValue"in r){let s=r.key,a=Object.entries(r.mapValue),i=new Map(a),n=new Map(a.map(e=>e.reverse()));e=(([e,t])=>e===s&&i.has(t)?[e,i.get(t)]:[e,t]),t=(([e,t])=>e===s&&n.has(t)?[e,n.get(t)]:[e,t])}M(this,a,e);let n,l;return this.on("update",n=(t=>K(a,t,e))),a.on("update",l=(e=>K(this,e,t))),k(this,x).push({data:a,leftUpdate:n,rightUpdate:l}),a[b]}};Object.keys(P).forEach(e=>{Object.defineProperty(v.prototype,e,{writable:!0,value:P[e]})});class A extends v{constructor(e,...t){super(...t),Object.defineProperty(this,"mappingXData",{value:e})}}return["concat","every","filter","find","findIndex","forEach","map","slice","some","indexOf","lastIndexOf","includes","join"].forEach(e=>{let t=Array.prototype[e];t&&Object.defineProperty(v.prototype,e,{value(...e){return t.apply(this,e)}})}),["pop","push","reverse","splice","shift","unshift"].forEach(e=>{let t=Array.prototype[e];t&&Object.defineProperty(v.prototype,e,{value(...s){let a=[],i=this[g];s.forEach(e=>{if(e instanceof v){let t=e[g];t.remove(),a.push(t)}else{let t=c(e,{parent:i});a.push(t)}});let r=t.apply(i,a);switch(i.forEach((e,t)=>{e instanceof v&&(e.index=t)}),e){case"shift":case"pop":r instanceof v&&l(r);break;case"splice":r.forEach(e=>{e instanceof v&&l(e)})}return n(i,e,s),r}})}),Object.defineProperty(v.prototype,"sort",{value(e){let t=[e],a=this[g],i=Array.from(a);if((e=>s(e).includes("function"))(e)){Array.prototype.sort.call(a,e),a.forEach((e,t)=>{e instanceof v&&(e.index=t)});t=[i.map(e=>e.index)],i=null}else e instanceof Array&&e.forEach((e,t)=>{(a[e]=i[t]).index=e});return n(a,"sort",t),this}}),window.XData=v,e=>c(e)[b]})());