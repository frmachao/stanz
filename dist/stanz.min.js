/*!
* stanz v6.2.2
* https://github.com/kirakiray/stanz
* 
* (c) 2018-2021 YAO
* Released under the MIT License.
*/((e,t)=>{"use strict";"object"==typeof exports?module.exports=t():"function"==typeof define&&define.amd?define(t):e.stanz=t()})(this,()=>{"use strict";const e=()=>Math.random().toString(32).substr(2);let t=Object.prototype.toString;const s=e=>t.call(e).toLowerCase().replace(/(\[object )|(])/g,""),r=e=>void 0===e,n=e=>s(e).includes("function"),i=e=>e instanceof T?e.object:JSON.parse(JSON.stringify(e)),a=(()=>{if(null!==document.currentScript.getAttribute("debug")){let t=new Map;return(s,r)=>{r||(r=e());let n=t.get(r);clearTimeout(n),t.set(r,setTimeout(()=>{s(),t.delete(r)}))}}let t=new Map;const s=e=>Promise.resolve().then(()=>e());"object"==typeof process&&process.nextTick&&(s=process.nextTick);let r=!1;return(n,i)=>{i||(i=e()),t.set(i,{key:i,fun:n}),r||(r=!0,s(()=>{t.size&&t.forEach(({key:e,fun:s})=>{try{s()}catch(e){console.error(e)}t.delete(e)}),t.clear(),r=!1}))}})(),l=(t,s,r,n,a)=>{let l;l=t._modifyId?t._modifyId:e(),P(t,S).push(l),h(t);let c=new x({type:"update",target:t[k]||t});Object.defineProperties(c,{trend:{get:()=>new A(c)}}),n&&Object.assign(c,n),c.modify={name:s,args:r.map(e=>e instanceof T?e.object:e instanceof Object?i(e):e),mid:l},a&&a(c),t.emit(c)};let c,o=new Set;const h=e=>{e[S].length<50||(clearTimeout(c),o.add(e),c=setTimeout(()=>{let e=Array.from(o);setTimeout(()=>{e.forEach(e=>h(e))},1e3),o.forEach(e=>{let t=e[S];t.splice(0,Math.ceil(t.length/2))}),o.clear()},3e3))},f=e=>{if(e instanceof M)return void(e=>{e.index=void 0,e.parent=void 0,e[$].mirrorHost.off("update",e[V]),e[$].mirrorHost=void 0})(e);if(!(e instanceof T))return;let t=e[D];if(t)try{t.index=void 0,t.parent=void 0}catch(e){}if(t[_])for(let[s,r]of t[_])e.unsync(s);t.emit("clearxdata"),t[E]&&t[E].clear(),t[b]&&t[b].clear()},d=(e,t)=>{if(e instanceof M)return e;let r=e;switch(s(e)){case"object":case"array":r=new T(e,t)}return r},u=(e,t)=>{if(e instanceof Array)return e.map(e=>u(e,t));if(e instanceof Object){let s={},r=[];return Object.keys(e).forEach(n=>{/\D/.test(n)?s[n]=u(e[n]):r.push(u(e[n],t))}),r.length&&(s[t]=r),s}return e};function p(e,t){if(!(e instanceof T))return!1;try{return t.call(e,e)}catch(e){}}let y=(e,t,s)=>{p(e,t)&&s.push(e),e instanceof T&&s.push(...e.seek(t,!1))};const b=Symbol("events"),g=(e,t)=>{let s=t[b];s||(s=new Map,Object.defineProperty(t,b,{value:s}));let r=s.get(e);return r||(r=[],s.set(e,r)),r},m=(e,t)=>{let s;return e instanceof x?e=(s=e).type:s=new x({type:e,target:t[k]||t}),s};class w{constructor(e={}){Object.defineProperties(this,{parent:{writable:!0,value:e.parent,configurable:!0},index:{writable:!0,value:e.index,configurable:!0}})}on(e,t,s){this.addListener({type:e,data:s,callback:t})}one(e,t,s){this.addListener({count:1,type:e,data:s,callback:t})}addListener(e={}){let{type:t,data:s,callback:n,count:i=1/0,eventId:a}=e;if(!t)throw{desc:"addListener no type",options:e};let l=t.split("#");1 in l&&(t=l[0],a=l[1]);let c=g(t,this);r(a)||Array.from(c).some(e=>{if(e.eventId===a){let t=c.indexOf(e);return t>-1&&c.splice(t,1),!0}}),n&&c.push({type:t,data:s,callback:n,eventId:a,count:i})}off(e,t){if(e){if(!t)throw{desc:"off must have callback"};{let s=g(e,this),r=s.findIndex(e=>e.callback==t);r>-1&&s.splice(r,1)}}}emitHandler(e,t){let s=m(e,this);e=s.type;let r=g(e,this),n=[];return s.currentTarget=this[k]||this,r.some(e=>{e.data&&(s.data=e.data),e.eventId&&(s.eventId=e.eventId);let r={self:this,event:s,emitData:t};if((e.before?e.before(r):1)&&e.callback.call(this[k]||this,s,t),e.after&&e.after(r),delete s.data,delete s.eventId,e.count--,e.count||n.push(e),s.cancel)return!0}),delete s.currentTarget,n.forEach(e=>{let t=r.indexOf(e);t>-1&&r.splice(t,1)}),s}emit(e,t){let s=this.emitHandler(e,t);if(s.bubble&&!s.cancel){let{parent:e}=this;e&&(s.keys.unshift(this.index),e.emit(s,t))}}}class x extends w{constructor(e){super(),this.type=e.type,this.target=e.target,this._bubble=!0,this._cancel=!1,this.keys=[]}get bubble(){return this._bubble}set bubble(e){this._bubble!==e&&(this.emitHandler("set-bubble",e),this._bubble=e)}get cancel(){return this._cancel}set cancel(e){this._cancel!==e&&(this.emitHandler("set-cancel",e),this._cancel=e)}}const j=/^_.+|^index$|^length$|^object$|^getData$|^setData$/,v=/^parent$|^index$|^length$|^object$/;let O={get:(e,t,s)=>"symbol"==typeof t||j.test(t)?Reflect.get(e,t,s):e.getData(t),set:(e,t,s,r)=>"symbol"==typeof t?Reflect.set(e,t,s,r):e.setData(t,s)};const k=Symbol("proxyThis"),D=Symbol("XDataSelf"),E=Symbol("WatchHost"),S=Symbol("ModifyIDS"),_=Symbol("SyncHost"),I=Symbol("StanzID"),P=(e,t)=>{let s=e[t];if(!s){switch(t){case E:case _:s=new Map;break;case S:case VIRDATAHOST:s=[]}Object.defineProperty(e,t,{value:s})}return s},K="undefined"!=typeof Element;class T extends w{constructor(t,s={}){super(s);let r=new Proxy(this,O),n=0,i=Object.getOwnPropertyDescriptors(t);Object.keys(i).forEach(e=>{let{value:t,get:s,set:r}=i[e];s||r?Object.defineProperty(this,e,{configurable:!0,enumerable:!0,get:s,set:r}):/^\_/.test(e)||K&&t instanceof Element?Object.defineProperty(this,e,{configurable:!0,writable:!0,value:t}):(/\D/.test(e)||(e=parseInt(e))>=n&&(n=e+1),t instanceof M?(this[e]=t,t.parent=this,t.index=e):t instanceof Object?this[e]=new T(t,{parent:this,index:e}):this[e]=t)});const a=e();Object.defineProperties(this,{[D]:{get:()=>this},[k]:{value:r},[I]:{value:a},xid:{get:()=>a},_modifyId:{value:null,writable:!0},length:{configurable:!0,writable:!0,value:n}})}setData(e,t){if(v.test(e))return console.warn("you can't set this key in XData => ",e),!1;if(/^_.+/.test(e))return Object.defineProperty(this,e,{configurable:!0,writable:!0,value:t}),!0;let r=this[D];if(/\./.test(e)){let s=e.split("."),n=s.length-1;return s.some((t,s)=>{if(s==n)return e=t,!0;r=r[t]}),r.setData(e,t),!0}let n=s(e);if("string"===n||"number"===n){let s=r[e];return t===s||(s instanceof T&&(s=s.object),t instanceof M?(t.parent&&t.remove(),t.parent=r,t.index=e):t instanceof T?(t[D]&&(t=t[D]),t.parent&&t.remove(),t.parent=r,t.index=e):t instanceof Object&&(t=d(t,{parent:r,index:e})),r[e]=t,l(r,"setData",[e,t],{oldValue:s}),!0)}if(e instanceof Object){let t=e;return Object.keys(t).forEach(e=>{let s=t[e];r.setData(e,s)}),!0}}getData(e){let t;if(e.includes&&e.includes(".")){let s=e.split(".");t=this;do{t=t[s.shift()]}while(s.length)}else t=this[e];return t instanceof T&&(t=t[k]),t}remove(e){if(r(e)){let{parent:e}=this;e?e.remove(this.index):f(this)}else{let t=this[e];/\D/.test(e)?(delete this[e],f(t),l(this,"remove",[e])):this.splice(parseInt(e),1)}}deepClear(){Object.keys(this).forEach(e=>{if(/\D/.test(e)){let t=this[e];t instanceof T&&t.deepClear(),t instanceof M&&f(t)}}),this.forEach(e=>{e instanceof T&&e.deepClear(),e instanceof M&&f(e)}),f(this)}add(e){!this.includes(e)&&this.push(e)}delete(e){let t=this.indexOf(e);t>-1&&this.splice(t,1)}has(e){return this.includes(e)}clear(){this.splice(0,this.length)}before(e){if(/\D/.test(this.index))throw{text:"It must be an array element",target:this,index:this.index};return this.parent.splice(this.index,0,e),this}after(e){if(/\D/.test(this.index))throw{text:"It must be an array element",target:this,index:this.index};return this.parent.splice(this.index+1,0,e),this}clone(){return d(i(this))[k]}emitHandler(e,t){let s=m(e,this);if("update"===s.type){let{_unBubble:e,_update:t,_unpush:r}=this,{fromKey:n}=s.trend;(!1===t||e&&e.includes(n))&&(s.bubble=!1),r&&r.includes(n)&&Object.defineProperty(s,"_unpush",{value:!0})}return w.prototype.emitHandler.call(this,s,t),s}noStanz(e={childKey:"children"}){return u(this.object,e.childKey)}get object(){let e={},t=!0,{_unBubble:s=[]}=this;return Object.keys(this).forEach(r=>{if(/^_/.test(r)||!/\D/.test(r)||s.includes(r)||"length"===r)return;let n=this[r];if(n instanceof T||n instanceof M){if(!1===n._update)return;n=n.object}e[r]=n,t=!1}),this.forEach((t,s)=>{(t instanceof T||t instanceof M)&&(t=t.object),e[s]=t}),t&&(e.length=this.length,e=Array.from(e)),e}get string(){return JSON.stringify(this.object)}toJSON(){return JSON.stringify(this.object)}get root(){let e=this;for(;e.parent;)e=e.parent;return e}get prev(){if(!/\D/.test(this.index)&&this.index>0)return this.parent.getData(this.index-1)}get next(){if(!/\D/.test(this.index))return this.parent.getData(this.index+1)}get mirror(){return new M(this)}getTarget(e){let t=this;return e.length&&e.some(e=>{if(!t)return console.warn("getTarget failure"),!0;t=t[e]}),t}watch(e,t,r){let n,i=s(e);if("object"===i)return void Object.keys(e).forEach(s=>{this.watch(s,e[s],t)});/function/.test(i)&&(r=t,t=e,e=""),n=""===e?"watchSelf":e instanceof RegExp?"watchKeyReg":/\./.test(e)?"watchPointKey":"watchKey";let l=P(this,E).get(e);l||(l=new Set,P(this,E).set(e,l));let c,o={trends:[],callback:t,expr:e,push(e){this.trends.push(e)}};l.add(o);let h=this[k];switch(n){case"watchSelf":c=(e=>{o.push(e.trend),a(()=>{t.call(h,{trends:Array.from(o.trends)},h),o.trends.length=0},o)}),!0===r&&t.call(h,{trends:[]},h);break;case"watchKey":case"watchKeyReg":c=(s=>{let{trend:r}=s;("watchKeyReg"===n&&e.test(r.fromKey)||r.fromKey==e)&&(o.push(s.trend),o.cacheOld||(o._oldVal=s.oldValue instanceof T?s.oldValue.object:s.oldValue,o.cacheOld=!0),a(()=>{let s=this[e];t.call(h,{expr:e,val:s,old:o._oldVal,trends:Array.from(o.trends)},s),o.trends.length=0,o._oldVal=o.cacheOld=!1},o))}),!0===r&&t.call(h,{expr:e,val:h[e],trends:[]},h[e]);break;case"watchPointKey":let s=e.split("."),i=this.getTarget(s);i=i instanceof T?i.object:i,c=(r=>{let{trend:n}=r,l=n.keys.slice();if(l.length<s.length&&l.push(n.finalSetterKey),JSON.stringify(s)===JSON.stringify(l.slice(0,s.length))){let l;try{l=this.getTarget(s)}catch(r){}l!==i&&(o.push(n),a(()=>{(l=this.getTarget(s))!==i&&t.call(h,{expr:e,old:i,trends:Array.from(o.trends)},l),o.trends.length=0},o))}}),!0===r&&t.call(h,{expr:e,val:i},i)}return this.on("update",c),o.updateMethod=c,this}unwatch(e,t){let r=s(e);if("object"===r)return Object.keys(e).forEach(t=>{this.unwatch(t,e[t])}),this;/function/.test(r)&&(t=e,e="");let n=P(this,E).get(e);if(n){let s=Array.from(n).find(s=>s.callback===t&&s.expr===e);s&&(s.updateMethod&&this.off("update",s.updateMethod),n.delete(s),!n.size&&P(this,E).delete(e))}return this}watchUntil(e){if(/[^=]=[^=]/.test(e))throw"cannot use single =";return new Promise(t=>{let s,r=new Function(`\n            try{with(this){\n                return ${e}\n            }}catch(e){}`).bind(this);this.watch(s=(()=>{let e=r();e&&(this.unwatch(s),t(e))}),!0)})}seek(e,t=!0){n(e)||(e=new Function(`with(this){return ${e}}`));let s=[];return t&&p(this,e)&&s.push(this),Object.keys(this).forEach(t=>{/\D/.test(t)&&y(this[t],e,s)}),this.forEach(t=>y(t,e,s)),s}entrend(e){let{mid:t,keys:s,name:r,args:n,_unpush:i}=e;if(i)return;let{_unpull:a}=this,l=H(e);if(a&&a.includes(l))return;if(!t)throw{text:"Illegal trend data"};let c=this.getTarget(s);if(c){let e=c[D];if(P(e,S).includes(t))return!1;e._modifyId=t,e[r](...n),e._modifyId=null}return!0}}const H=e=>{let t=e.keys[0];return!r(t)||"setData"!==e.name&&"remove"!==e.name||(t=e.args[0]),t};class A{constructor(e){if(e instanceof x){let{modify:{name:t,args:s,mid:r},keys:n}=i(e),{_unpush:a}=e;a&&Object.defineProperty(this,"_unpush",{value:!0}),Object.assign(this,{name:t,args:s,mid:r,keys:n})}else Object.assign(this,e)}get string(){return JSON.stringify(this)}get finalSetterKey(){switch(this.name){case"remove":case"setData":return this.args[0]}}get fromKey(){return H(this)}set fromKey(e){let t=this.keys[0];r(t)?"setData"!==this.name&&"remove"!==this.name||(this.args[0]=e):this.keys[0]=e}}class M{constructor(e){this[$]=this,this.mirrorHost=e,this.parent=void 0,this.index=void 0;let t=e=>{this.parent&&l(this.parent,"",[],{},t=>{Object.assign(t,{keys:i(e.keys),modify:i(e.modify),currentTarget:e.currentTarget,target:e.target,oldValue:e.oldValue}),t.keys.unshift(this.index)})};return e.on("update",t),this[V]=t,new Proxy(this,J)}remove(e){return T.prototype.remove.call(this,e)}}const V=Symbol("XMirrorUpdataBinder"),$=Symbol("XMirror_self"),R=new Set(["index","parent","remove",V,$]),J={get(e,t,s){if(R.has(t))return Reflect.get(e,t,s);let r;return r="symbol"==typeof t?e.mirrorHost[t]:e.mirrorHost.getData(t),n(r)&&(r=r.bind(e.mirrorHost[k])),r},set:(e,t,s,r)=>R.has(t)?Reflect.set(e,t,s,r):e.mirrorHost.setData(t,s)},N=(e,t,s)=>{t.trends.forEach(t=>{t.fromKey===e&&s.entrend(t)})},W=(e,t,s)=>{t.trends.forEach(t=>{e.includes(t.fromKey)&&s.entrend(t)})},z=(e,t,s)=>{i(t.trends).forEach(t=>{t=new A(t);let{fromKey:n}=t;if(!r(n)){let r=e.get(n);r&&(t.fromKey=r,s.entrend(t))}})},L=e=>(e instanceof T&&(e=e.object),e),C={sync(e,t,r){let n,i;switch(s(t)){case"string":r&&e.setData(t,L(this[t])),n=(s=>N(t,s,e)),i=(e=>N(t,e,this));break;case"array":r&&t.forEach(t=>{e.setData(t,L(this[t]))}),n=(s=>W(t,s,e)),i=(e=>W(t,e,this));break;case"object":let a=new Map(Object.entries(t)),l=new Map(Object.entries(t).map(e=>e.reverse()));r&&Object.keys(t).forEach(s=>{e.setData(t[s],L(this[s]))}),n=(t=>z(a,t,e)),i=(e=>z(l,e,this));break;default:if(r){let t=this.object;Object.keys(t).forEach(s=>{e.setData(s,t[s])})}n=(t=>t.trends.forEach(t=>e.entrend(t))),i=(e=>e.trends.forEach(e=>this.entrend(e)))}this.watch(n),e.watch(i);let a=P(this,_);a.has(e)&&this.unsync(e),a.set(e,{selfWatch:n,oppWatch:i}),P(e,_).set(this,{selfWatch:i,oppWatch:n})},unsync(e){let t=P(this,_).get(e);if(t){let{selfWatch:s,oppWatch:r}=t;this.unwatch(s),e.unwatch(r),P(this,_).delete(e),P(e,_).delete(this)}}};Object.keys(C).forEach(e=>{Object.defineProperty(T.prototype,e,{writable:!0,value:C[e]})}),["concat","every","filter","find","findIndex","forEach","map","slice","some","indexOf","lastIndexOf","includes","join"].forEach(e=>{let t=Array.prototype[e];t&&Object.defineProperty(T.prototype,e,{value(...e){return t.apply(this,e)}})});const X=(e,t,s)=>{(e instanceof T||e instanceof M)&&t!==s&&(e.index=t,e.emitHandler("updateIndex",{oldIndex:s,index:t}))};["pop","push","reverse","splice","shift","unshift"].forEach(e=>{let t=Array.prototype[e];t&&Object.defineProperty(T.prototype,e,{value(...s){let r=[],n=this[D],i=n.object;s.forEach(e=>{if(e instanceof T){let t=e[D];t.remove(),r.push(t)}else if(e instanceof M)e.parent=n,r.push(e);else{let t=d(e,{parent:n});r.push(t)}});let a=t.apply(n,r);switch(n.forEach((e,t)=>{let s=e.index;X(e,t,s)}),e){case"shift":case"pop":(a instanceof T||a instanceof M)&&f(a);break;case"splice":a.forEach(e=>{(e instanceof T||e instanceof M)&&f(e)})}return l(n,e,s,{oldValue:i}),a}})}),Object.defineProperties(T.prototype,{sort:{value(e){let t=[],s=this[D],r=s.object,i=Array.from(s);if(n(e)||!e){Array.prototype.sort.call(s,e),s.forEach((e,t)=>{let s=e.index;X(e,t,s)}),t=[i.map(e=>e.index)],i=null}else e instanceof Array&&(e.forEach((e,t)=>{let r=s[e]=i[t],n=r.index;X(r,e,n)}),t=[e]);return l(s,"sort",t,{oldValue:r}),this}}});let B=e=>d(e)[k];return B.version="6.2.2",B.v=6002002,B});